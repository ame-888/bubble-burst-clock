---
import Layout from '../layouts/Layout.astro';
import { predictions } from '../data/predictions';
import en from '../locales/en.json';
import ptBR from '../locales/pt-BR.json';
import ja from '../locales/ja.json';
import es from '../locales/es.json';
import zh from '../locales/zh.json';

const translations = {
    'en': en,
    'pt-BR': ptBR,
    'ja': ja,
    'es': es,
    'zh': zh,
};

const lang = 'en';
const t = translations[lang];

// --- Status Logic for counts ---
const now = new Date('2025-12-03T00:00:00Z');

const processedPredictions = predictions.map(p => {
    let status = 'FUTURE PREDICTION';
    const start = p.validityStart ? new Date(p.validityStart) : null;
    const end = p.validityEnd ? new Date(p.validityEnd) : null;

    if (start && end) {
        if (now < start) {
            status = 'FUTURE PREDICTION';
        } else if (now >= start && now <= end) {
            status = 'ACTIVE';
        } else {
            status = 'EXPIRED';
        }
    }
    return { ...p, status };
});

// --- Player Cards Logic ---
const creatorsData = {};
processedPredictions.forEach(p => {
    if (!creatorsData[p.creator]) {
        creatorsData[p.creator] = {
            name: p.creator,
            total: 0,
            failures: 0,
            pending: 0,
            successes: 0,
            predictions: []
        };
    }
    creatorsData[p.creator].total++;
    creatorsData[p.creator].predictions.push(p);

    if (p.status === 'EXPIRED') {
        creatorsData[p.creator].failures++;
    } else if (p.status === 'ACTIVE' || p.status === 'FUTURE PREDICTION') {
        creatorsData[p.creator].pending++;
    } else {
        creatorsData[p.creator].successes++;
    }
});

// Deterministic RPG Stats Generator
function getRPGStats(name) {
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    const rng = (seed) => {
        const x = Math.sin(seed) * 10000;
        return Math.floor((Math.abs(x - Math.floor(x))) * 100); // 0-99
    };
    const scale = (val) => 10 + Math.floor(val * 0.89);

    return {
        STR: scale(rng(hash)),
        INT: scale(rng(hash + 1)),
        CHA: scale(rng(hash + 2)),
        LUCK: scale(rng(hash + 3))
    };
}

const players = Object.values(creatorsData).map(c => {
    // @ts-ignore
    const stats = getRPGStats(c.name);
    // Success Rate: (Success / (Success + Failure)) * 100. If 0 completed, 0%.
    // @ts-ignore
    const completed = c.successes + c.failures;
    // @ts-ignore
    const successRate = completed > 0 ? ((c.successes / completed) * 100).toFixed(0) : 0;

    // Assign a "Class" based on stats or name
    let rpgClass = "Doomer"; // Default
    if (stats.INT > 85) rpgClass = "Technomancer";
    else if (stats.CHA > 85) rpgClass = "Cult Leader";
    else if (stats.STR > 85) rpgClass = "Bubble Burster";
    else if (stats.LUCK > 85) rpgClass = "Oracle";

    // Rarity Map
    const rarityMap = {
        "Gary Marcus": "Legendary",
        "O Primo Rico": "Legendary",
        "Sabine Hossenfelder": "Legendary",
        "Adam Conover": "Epic",
        "Brianne Worth": "Epic",
        "Cole Hastings": "Epic",
        "Man Carrying Thing": "Epic",
        "Georg Rockall-Schmidt": "Epic",
        "Sasha Yanshin": "Epic",
        "OverEasy": "Rare",
        "Shade of Code": "Rare"
    };

    // @ts-ignore
    const rarity = rarityMap[c.name] || "Common";

    // MTG Color Mapping
    let mtgColor = "white"; // Doomer/Default
    if (rpgClass === "Technomancer") mtgColor = "blue";
    else if (rpgClass === "Cult Leader") mtgColor = "black";
    else if (rpgClass === "Bubble Burster") mtgColor = "red";
    else if (rpgClass === "Oracle") mtgColor = "green";

    // Flavor Text
    const flavorTextMap = {
        "Technomancer": "Logic is a prison waiting to be broken.",
        "Cult Leader": "Belief is the only currency that matters.",
        "Bubble Burster": "Reality has a way of asserting itself.",
        "Oracle": "I see what you refuse to acknowledge.",
        "Doomer": "The end is not near, it is here."
    };
    const flavorText = flavorTextMap[rpgClass] || "A watcher of the bubble.";

    // Last Entry Date (for sorting)
    const latestDate = Math.max(...c.predictions.map(p => {
        const d = p.uploadDate ? new Date(p.uploadDate) : new Date(0);
        return d.getTime();
    }));

    return { ...c, stats, successRate, rpgClass, rarity, mtgColor, flavorText, latestDate };
    // @ts-ignore
}).sort((a, b) => b.total - a.total); // Default sort
---

<Layout lang={lang} title={`${t.player_cards_title} - ${t.title}`}>
    <main>
        <h1 id="player-cards-title">{t.player_cards_title}</h1>

        <!-- Sorting Controls -->
        <div class="sort-controls">
            <label for="sort-select" class="sort-label">Sort by:</label>
            <select id="sort-select" class="sort-select">
                <option value="famous_desc">Most Famous</option>
                <option value="famous_asc">Least Famous</option>
                <option value="date_desc">Latest Entry</option>
                <option value="date_asc">Oldest Entry</option>
                <option value="name_asc">Name (A-Z)</option>
                <option value="name_desc">Name (Z-A)</option>
            </select>
        </div>

        <div class="player-container">
            <!-- Grid View -->
            <div id="player-grid-view" class="">
                <div class="player-grid" id="player-grid-container">
                    {players.map(player => (
                        <div class="player-card-mini"
                             data-player-name={player.name}
                             data-rarity={player.rarity}
                             data-mtg-color={player.mtgColor}
                             data-latest-date={player.latestDate}>

                            <div class="card-inner">
                                <div class="card-face-content">
                                    <div class="mini-header">
                                        <div class="mini-name">{player.name}</div>
                                        <div class="mini-mana">{player.total}</div>
                                    </div>
                                    <div class="mini-art">
                                        <div class="mini-avatar">{player.name.substring(0, 1).toUpperCase()}</div>
                                    </div>
                                    <div class="mini-type-line">
                                        {player.rpgClass}
                                    </div>
                                    <div class="mini-text-box">
                                        <div class="mini-rarity-symbol"></div>
                                        <div class="mini-stats">
                                            <span>S:{player.stats.STR}</span>
                                            <span>I:{player.stats.INT}</span>
                                        </div>
                                    </div>
                                    <div class="mini-pt">
                                        {player.successes}/{player.total}
                                    </div>
                                </div>
                            </div>

                        </div>
                    ))}
                </div>
            </div>

            <!-- Detail View -->
            <div id="player-detail-view" class="hidden">
                <div class="detail-nav">
                    <button id="back-to-grid" class="back-button">← Back</button>
                    <div class="nav-arrows">
                         <button id="prev-card" class="nav-arrow" aria-label="Previous">←</button>
                         <button id="next-card" class="nav-arrow" aria-label="Next">→</button>
                    </div>
                </div>

                <div class="mtg-card-container" id="mtg-card-container">
                    <!-- Dynamic classes for color/rarity will be added here via JS -->
                    <div class="mtg-card-border">
                        <div class="mtg-card-content">
                            <!-- Header -->
                            <div class="mtg-header">
                                <span id="detail-name" class="mtg-card-name">Player Name</span>
                                <span id="detail-mana" class="mtg-mana-cost"></span>
                            </div>

                            <!-- Art -->
                            <div class="mtg-art-frame">
                                <div class="mtg-art-inner">
                                    <div class="rpg-avatar" id="detail-avatar"></div>
                                </div>
                            </div>

                            <!-- Type Line -->
                            <div class="mtg-type-line">
                                <span id="detail-type-text">Legendary Creature — Class</span>
                                <div id="detail-set-symbol" class="mtg-set-symbol"></div>
                            </div>

                            <!-- Text Box -->
                            <div class="mtg-text-box">
                                <ul id="detail-predictions-list" class="mtg-abilities-list">
                                    <!-- Populated by JS -->
                                </ul>
                                <div class="mtg-flavor-separator"></div>
                                <div id="detail-flavor" class="mtg-flavor-text">
                                    "Flavor text goes here."
                                </div>
                            </div>

                            <!-- Footer -->
                            <div class="mtg-footer">
                                <div class="mtg-pt-box">
                                    <span id="detail-pt">0 / 0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</Layout>

<style>
    main {
        max-width: 80rem;
        margin: 4rem auto;
        padding: 0 1rem;
    }

    h1 {
        font-size: 3rem;
        font-weight: 900;
        text-align: center;
        margin-bottom: 2rem;
        color: white;
        background: linear-gradient(to right, #10B981, #059669);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* Grid View */
    .sort-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 2rem;
        gap: 1rem;
    }

    .sort-label {
        color: #D1D5DB;
        font-weight: 600;
    }

    .sort-select {
        background: rgba(31, 41, 55, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-family: 'Inter', sans-serif;
    }

    .player-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 2rem;
        margin-top: 1.5rem;
        perspective: 1000px;
    }

    /* Enhanced Mini Card Style */
    .player-card-mini {
        width: 100%;
        aspect-ratio: 2.5/3.5;
        background: transparent;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
    }

    .player-card-mini:hover {
        transform: translateY(-10px) rotateX(5deg);
        z-index: 10;
    }

    .card-inner {
        width: 100%;
        height: 100%;
        border-radius: 12px;
        background: #1a1a1a;
        padding: 6px; /* Border thickness */
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        position: relative;
        overflow: hidden;
    }

    /* Dynamic Border Colors based on Rarity/Color via attributes later,
       but for now we use the inner content structure */

    .card-face-content {
        width: 100%;
        height: 100%;
        background: #e0e0e0;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        padding: 0.3rem;
        gap: 0.2rem;
        border: 1px solid #000;
    }

    /* Rarity/Color Styling for Grid */
    /* We need to apply these classes dynamically or use global styles */

    :global(.player-card-mini[data-mtg-color="blue"] .card-inner) { background: #1a3c5e; box-shadow: 0 0 10px rgba(0, 100, 255, 0.3); }
    :global(.player-card-mini[data-mtg-color="blue"] .card-face-content) { background: #b0c4de; }

    :global(.player-card-mini[data-mtg-color="black"] .card-inner) { background: #222; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); }
    :global(.player-card-mini[data-mtg-color="black"] .card-face-content) { background: #a9a9a9; }

    :global(.player-card-mini[data-mtg-color="red"] .card-inner) { background: #5e1a1a; box-shadow: 0 0 10px rgba(255, 50, 50, 0.3); }
    :global(.player-card-mini[data-mtg-color="red"] .card-face-content) { background: #e6b0b0; }

    :global(.player-card-mini[data-mtg-color="green"] .card-inner) { background: #1a5e2a; box-shadow: 0 0 10px rgba(50, 255, 50, 0.3); }
    :global(.player-card-mini[data-mtg-color="green"] .card-face-content) { background: #b0e6b6; }

    :global(.player-card-mini[data-mtg-color="white"] .card-inner) { background: #dcdcdc; box-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }
    :global(.player-card-mini[data-mtg-color="white"] .card-face-content) { background: #f5f5f5; }

    /* Rarity Glow */
    :global(.player-card-mini[data-rarity="Legendary"] .card-inner) {
        border: 2px solid #FFD700;
        animation: pulse-legendary 3s infinite;
    }
    @keyframes pulse-legendary {
        0% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
        100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
    }

    .mini-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255,255,255,0.6);
        border: 1px solid #666;
        border-radius: 4px;
        padding: 2px 4px;
    }
    .mini-name {
        font-size: 0.65rem;
        font-weight: 700;
        color: black;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 80%;
    }
    .mini-mana {
        font-size: 0.6rem;
        background: #ccc;
        border-radius: 50%;
        width: 14px;
        height: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #555;
        color: black;
        font-weight: bold;
    }

    .mini-art {
        flex: 1;
        background: #333;
        border: 1px solid #000;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
    }
    /* Add a subtle texture to art */
    .mini-art::after {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.1'/%3E%3C/svg%3E");
        opacity: 0.3;
    }

    .mini-avatar {
        font-size: 3rem;
        font-weight: 900;
        color: rgba(255,255,255,0.1);
        text-shadow: 0 0 5px rgba(255,255,255,0.2);
    }

    .mini-type-line {
        font-size: 0.5rem;
        font-weight: 700;
        color: black;
        background: rgba(255,255,255,0.5);
        border: 1px solid #666;
        padding: 1px 3px;
        border-radius: 2px;
    }

    .mini-text-box {
        background: rgba(255,255,255,0.7);
        border: 1px solid #666;
        flex: 0.6;
        padding: 2px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .mini-stats {
        font-size: 0.5rem;
        color: #333;
        display: flex;
        justify-content: space-between;
    }

    .mini-rarity-symbol {
        align-self: flex-end;
        font-size: 0.8rem;
    }
    :global(.player-card-mini[data-rarity="Common"] .mini-rarity-symbol::after) { content: '●'; color: black; }
    :global(.player-card-mini[data-rarity="Rare"] .mini-rarity-symbol::after) { content: '★'; color: #C0C0C0; text-shadow: 0 0 1px black; }
    :global(.player-card-mini[data-rarity="Epic"] .mini-rarity-symbol::after) { content: '◆'; color: #9932CC; text-shadow: 0 0 1px black; }
    :global(.player-card-mini[data-rarity="Legendary"] .mini-rarity-symbol::after) { content: '♛'; color: #FF4500; text-shadow: 0 0 1px black; }

    .mini-pt {
        background: #ddd;
        border: 2px solid #666;
        border-radius: 6px;
        padding: 1px 4px;
        font-size: 0.7rem;
        font-weight: 900;
        color: black;
        align-self: flex-end;
        margin-top: -8px;
        z-index: 5;
        position: relative;
        box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    }


    /* Detail View (MTG Style) */
    .hidden { display: none !important; }

    .detail-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        width: 100%;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    .back-button, .nav-arrow {
        background: rgba(31, 41, 55, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    .back-button:hover, .nav-arrow:hover {
        background: rgba(55, 65, 81, 0.8);
        border-color: #60A5FA;
    }

    .nav-arrows {
        display: flex;
        gap: 0.5rem;
    }

    /* MTG Card Styles (Reused & Enhanced) */
    .mtg-card-container {
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
        font-family: 'Times New Roman', serif; /* Use serif for authenticity */
        position: relative;
        border-radius: 18px; /* Slightly rounder */
        padding: 12px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.7);
    }

    /* Colors - Detail */
    .mtg-card-container.white { background: linear-gradient(135deg, #e0e0e0, #ffffff); }
    .mtg-card-container.blue { background: linear-gradient(135deg, #2b6cb0, #90cdf4); }
    .mtg-card-container.black { background: linear-gradient(135deg, #1a202c, #4a5568); }
    .mtg-card-container.red { background: linear-gradient(135deg, #9b2c2c, #fc8181); }
    .mtg-card-container.green { background: linear-gradient(135deg, #276749, #68d391); }

    .mtg-card-border {
        background: #171717;
        border-radius: 12px;
        padding: 5px; /* Black border thickness */
        height: 100%;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    }

    .mtg-card-content {
        background: #d4d4d4;
        border-radius: 8px;
        padding: 0.6rem;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        height: 100%;
        position: relative;
    }
    /* Add subtle paper texture to content */
    .mtg-card-content::before {
        content: '';
        position: absolute;
        top:0; left:0; width:100%; height:100%;
        opacity: 0.05;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        pointer-events: none;
        border-radius: 8px;
    }

    /* Inner Face Colors */
    .mtg-card-container.white .mtg-card-content { background: #F3F4F6; }
    .mtg-card-container.blue .mtg-card-content { background: #BFDBFE; }
    .mtg-card-container.black .mtg-card-content { background: #D1D5DB; } /* Grey for readability */
    .mtg-card-container.red .mtg-card-content { background: #FECACA; }
    .mtg-card-container.green .mtg-card-content { background: #A7F3D0; }

    /* Header */
    .mtg-header {
        border: 2px solid #4a5568;
        background: rgba(255,255,255,0.7);
        border-radius: 8px 8px 4px 4px;
        padding: 0.3rem 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        z-index: 1;
    }
    .mtg-card-name {
        font-weight: 700;
        font-size: 1.15rem;
        color: #1a202c;
    }
    .mtg-mana-cost {
        font-weight: 700;
        color: #1a202c;
        font-size: 0.9rem;
        background: #E5E7EB;
        border-radius: 50%;
        width: 26px;
        height: 26px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #4B5563;
        box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    /* Art */
    .mtg-art-frame {
        background: #000;
        padding: 2px;
        margin: 0.1rem 0;
        border: 2px solid #4a5568;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
    }
    .mtg-art-inner {
        background: #1F2937;
        height: 180px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
    }
    .rpg-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: rgba(255,255,255,0.05);
        border: 3px solid rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4rem;
        font-weight: 900;
        color: rgba(255,255,255,0.8);
        text-shadow: 0 0 10px rgba(255,255,255,0.5);
    }

    /* Type Line */
    .mtg-type-line {
        border: 2px solid #4a5568;
        background: rgba(255,255,255,0.7);
        padding: 0.3rem 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95rem;
        font-weight: 700;
        color: #1a202c;
        box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        z-index: 1;
        border-radius: 4px;
    }

    .mtg-set-symbol {
        font-size: 1.4rem;
        line-height: 1;
    }
    .mtg-card-container.common .mtg-set-symbol::after { content: '●'; color: #1a202c; }
    .mtg-card-container.rare .mtg-set-symbol::after { content: '★'; color: #C0C0C0; text-shadow: 1px 1px 0 #000; }
    .mtg-card-container.epic .mtg-set-symbol::after { content: '◆'; color: #9F7AEA; text-shadow: 1px 1px 0 #000; }
    .mtg-card-container.legendary .mtg-set-symbol::after { content: '♛'; color: #F6AD55; text-shadow: 1px 1px 0 #000; }

    /* Text Box */
    .mtg-text-box {
        border: 2px solid #4a5568;
        background: rgba(255,255,255,0.8);
        padding: 0.8rem;
        flex: 1;
        font-size: 0.9rem;
        color: #1a202c;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        min-height: 160px;
        z-index: 1;
        border-radius: 4px;
    }

    .mtg-abilities-list {
        list-style: none;
        padding: 0;
        margin: 0;
        flex: 1;
        overflow-y: auto;
    }

    :global(.mtg-abilities-list li) {
        margin-bottom: 0.6rem;
        line-height: 1.4;
        display: flex;
        gap: 0.5rem;
        align-items: flex-start;
    }

    .mtg-ability-bullet {
        font-size: 0.8rem;
        margin-top: 2px;
    }
    .bullet-future { color: #3B82F6; text-shadow: 0 0 1px #3B82F6; }
    .bullet-active { color: #10B981; text-shadow: 0 0 1px #10B981; }
    .bullet-expired { color: #EF4444; text-shadow: 0 0 1px #EF4444; }

    .mtg-flavor-separator {
        height: 1px;
        background: #4a5568;
        opacity: 0.3;
        margin: 0.4rem 0;
        width: 80%;
        align-self: center;
    }

    .mtg-flavor-text {
        font-style: italic;
        font-size: 0.85rem;
        opacity: 0.9;
        text-align: center;
    }

    /* Footer / P/T */
    .mtg-footer {
        display: flex;
        justify-content: flex-end;
        margin-top: -16px; /* Overlap text box */
        margin-right: -4px;
        z-index: 10;
        position: relative;
    }
    .mtg-pt-box {
        background: #E5E7EB;
        border: 2px solid #4a5568;
        padding: 0.3rem 0.8rem;
        border-radius: 12px;
        font-weight: 800;
        font-size: 1.1rem;
        color: #1a202c;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    }
    .mtg-card-container.black .mtg-pt-box { background: #D1D5DB; }
    .mtg-card-container.blue .mtg-pt-box { background: #BFDBFE; }

</style>

<script define:vars={{ translations, lang, players }}>
    // We need to inject the logic to handle the card interactions here
    // It is almost identical to the modal logic but scoped to this page

    function init() {
        let currentLang = lang;
        try {
            currentLang = localStorage.getItem('language') || document.cookie.split('; ').find(row => row.startsWith('language='))?.split('=')[1] || lang;
        } catch (e) {
            console.warn('Language detection failed:', e);
        }

        const t = translations[currentLang] || translations['en'];

        // Update title if needed
        const title = document.getElementById('player-cards-title');
        if (title) title.textContent = t.player_cards_title;

        // Interaction Logic
        const gridView = document.getElementById('player-grid-view');
        const detailView = document.getElementById('player-detail-view');
        const backBtn = document.getElementById('back-to-grid');
        const gridContainer = document.getElementById('player-grid-container');
        const sortSelect = document.getElementById('sort-select');
        const prevBtn = document.getElementById('prev-card');
        const nextBtn = document.getElementById('next-card');

        let currentSortedPlayers = [...players];
        let currentIndex = -1;

        // Rarity Priority Map for Sorting
        const rarityVal = { "Legendary": 4, "Epic": 3, "Rare": 2, "Common": 1 };

        function updateGrid() {
            if (!gridContainer) return;
            gridContainer.innerHTML = '';

            // Re-render based on sorted list
            currentSortedPlayers.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-card-mini';
                div.dataset.playerName = player.name;
                div.dataset.rarity = player.rarity;
                div.dataset.mtgColor = player.mtgColor;
                div.dataset.latestDate = player.latestDate;

                div.innerHTML = `
                    <div class="card-inner">
                        <div class="card-face-content">
                            <div class="mini-header">
                                <div class="mini-name">${player.name}</div>
                                <div class="mini-mana">${player.total}</div>
                            </div>
                            <div class="mini-art">
                                <div class="mini-avatar">${player.name.substring(0, 1).toUpperCase()}</div>
                            </div>
                            <div class="mini-type-line">
                                ${player.rpgClass}
                            </div>
                            <div class="mini-text-box">
                                <div class="mini-rarity-symbol"></div>
                                <div class="mini-stats">
                                    <span>S:${player.stats.STR}</span>
                                    <span>I:${player.stats.INT}</span>
                                </div>
                            </div>
                            <div class="mini-pt">
                                ${player.successes}/${player.total}
                            </div>
                        </div>
                    </div>
                `;
                div.addEventListener('click', () => openDetail(player.name));
                gridContainer.appendChild(div);
            });
        }

        function sortPlayers(mode) {
            if (mode === 'famous_desc') {
                currentSortedPlayers.sort((a, b) => (rarityVal[b.rarity] || 1) - (rarityVal[a.rarity] || 1));
            } else if (mode === 'famous_asc') {
                currentSortedPlayers.sort((a, b) => (rarityVal[a.rarity] || 1) - (rarityVal[b.rarity] || 1));
            } else if (mode === 'date_desc') {
                currentSortedPlayers.sort((a, b) => b.latestDate - a.latestDate);
            } else if (mode === 'date_asc') {
                currentSortedPlayers.sort((a, b) => a.latestDate - b.latestDate);
            } else if (mode === 'name_asc') {
                currentSortedPlayers.sort((a, b) => a.name.localeCompare(b.name));
            } else if (mode === 'name_desc') {
                currentSortedPlayers.sort((a, b) => b.name.localeCompare(a.name));
            }
            updateGrid();
        }

        if (sortSelect) {
            sortSelect.addEventListener('change', (e) => sortPlayers(e.target.value));
            // Initial sort
            sortPlayers(sortSelect.value);
        }

        function openDetail(name) {
             const index = currentSortedPlayers.findIndex(p => p.name === name);
             if (index === -1) return;
             currentIndex = index;
             renderDetail(currentSortedPlayers[currentIndex]);

             gridView.classList.add('hidden');
             detailView.classList.remove('hidden');
        }

        function renderDetail(player) {
            // Populate Detail View (MTG Style)
            const dName = document.getElementById('detail-name');
            if (dName) dName.textContent = player.name;

            const dType = document.getElementById('detail-type-text');
            if (dType) dType.textContent = `${player.rarity} ${player.rpgClass}`;

            const dMana = document.getElementById('detail-mana');
            if (dMana) dMana.textContent = player.total;

            const dAvatar = document.getElementById('detail-avatar');
            if (dAvatar) dAvatar.textContent = player.name.substring(0, 1).toUpperCase();

            const dPt = document.getElementById('detail-pt');
            if (dPt) dPt.textContent = `${player.successes}/${player.total}`;

            const dFlavor = document.getElementById('detail-flavor');
            if (dFlavor) dFlavor.textContent = `"${player.flavorText}"`;

            // Update Lists
            const list = document.getElementById('detail-predictions-list');
            if (list) {
                list.innerHTML = '';
                player.predictions.forEach(p => {
                    const li = document.createElement('li');

                    // Localize claim if object
                    let claimText = '';
                    if (typeof p.claim === 'string') claimText = p.claim;
                    else if (typeof p.claim === 'object') claimText = p.claim[currentLang] || p.claim['en'];

                    let bulletColorClass = 'bullet-future';
                    if (p.status === 'ACTIVE') bulletColorClass = 'bullet-active';
                    if (p.status === 'EXPIRED') bulletColorClass = 'bullet-expired';

                    // Use a colored bullet point instead of text label
                    li.innerHTML = `<span class="mtg-ability-bullet ${bulletColorClass}">●</span> <span>${claimText}</span>`;
                    list.appendChild(li);
                });
            }

            // Apply Styles
            const container = document.getElementById('mtg-card-container');
            if (container) {
                container.className = 'mtg-card-container'; // Reset
                container.classList.add(player.mtgColor.toLowerCase());
                container.classList.add(player.rarity.toLowerCase());
            }
        }

        if (backBtn && gridView && detailView) {
            backBtn.addEventListener('click', () => {
                detailView.classList.add('hidden');
                gridView.classList.remove('hidden');
            });
        }

        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    renderDetail(currentSortedPlayers[currentIndex]);
                } else {
                    // Loop to end
                    currentIndex = currentSortedPlayers.length - 1;
                    renderDetail(currentSortedPlayers[currentIndex]);
                }
            });
        }

        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                if (currentIndex < currentSortedPlayers.length - 1) {
                    currentIndex++;
                    renderDetail(currentSortedPlayers[currentIndex]);
                } else {
                    // Loop to start
                    currentIndex = 0;
                    renderDetail(currentSortedPlayers[currentIndex]);
                }
            });
        }
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
