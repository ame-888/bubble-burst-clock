---
import Layout from '../layouts/Layout.astro';
import { predictions } from '../data/predictions';
import en from '../locales/en.json';
import ptBR from '../locales/pt-BR.json';
import ja from '../locales/ja.json';
import es from '../locales/es.json';
import zh from '../locales/zh.json';

const translations = {
    'en': en,
    'pt-BR': ptBR,
    'ja': ja,
    'es': es,
    'zh': zh,
};

const lang = 'en';
const t = translations[lang];

// --- Status Logic for counts ---
const now = new Date('2025-12-03T00:00:00Z');

const processedPredictions = predictions.map(p => {
    let status = 'FUTURE PREDICTION';
    const start = p.validityStart ? new Date(p.validityStart) : null;
    const end = p.validityEnd ? new Date(p.validityEnd) : null;

    if (start && end) {
        if (now < start) {
            status = 'FUTURE PREDICTION';
        } else if (now >= start && now <= end) {
            status = 'ACTIVE';
        } else {
            status = 'EXPIRED';
        }
    }
    return { ...p, status };
});

// --- Player Cards Logic ---
const creatorsData = {};
processedPredictions.forEach(p => {
    if (!creatorsData[p.creator]) {
        creatorsData[p.creator] = {
            name: p.creator,
            total: 0,
            failures: 0,
            pending: 0,
            successes: 0,
            predictions: []
        };
    }
    creatorsData[p.creator].total++;
    creatorsData[p.creator].predictions.push(p);

    if (p.status === 'EXPIRED') {
        creatorsData[p.creator].failures++;
    } else if (p.status === 'ACTIVE' || p.status === 'FUTURE PREDICTION') {
        creatorsData[p.creator].pending++;
    } else {
        creatorsData[p.creator].successes++;
    }
});

// Deterministic RPG Stats Generator
function getRPGStats(name) {
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    const rng = (seed) => {
        const x = Math.sin(seed) * 10000;
        return Math.floor((Math.abs(x - Math.floor(x))) * 100); // 0-99
    };
    const scale = (val) => 10 + Math.floor(val * 0.89);

    return {
        STR: scale(rng(hash)),
        INT: scale(rng(hash + 1)),
        CHA: scale(rng(hash + 2)),
        LUCK: scale(rng(hash + 3))
    };
}

const players = Object.values(creatorsData).map(c => {
    // @ts-ignore
    const stats = getRPGStats(c.name);
    // Success Rate: (Success / (Success + Failure)) * 100. If 0 completed, 0%.
    // @ts-ignore
    const completed = c.successes + c.failures;
    // @ts-ignore
    const successRate = completed > 0 ? ((c.successes / completed) * 100).toFixed(0) : 0;

    // Assign a "Class" based on stats or name
    let rpgClass = "Doomer"; // Default
    if (stats.INT > 85) rpgClass = "Technomancer";
    else if (stats.CHA > 85) rpgClass = "Cult Leader";
    else if (stats.STR > 85) rpgClass = "Bubble Burster";
    else if (stats.LUCK > 85) rpgClass = "Oracle";

    // Rarity Map
    const rarityMap = {
        "Gary Marcus": "Legendary",
        "O Primo Rico": "Legendary",
        "Sabine Hossenfelder": "Legendary",
        "Adam Conover": "Epic",
        "Brianne Worth": "Epic",
        "Cole Hastings": "Epic",
        "Man Carrying Thing": "Epic",
        "Georg Rockall-Schmidt": "Epic",
        "Sasha Yanshin": "Epic",
        "OverEasy": "Rare",
        "Shade of Code": "Rare"
    };

    // @ts-ignore
    const rarity = rarityMap[c.name] || "Common";

    // MTG Color Mapping
    let mtgColor = "white"; // Doomer/Default
    if (rpgClass === "Technomancer") mtgColor = "blue";
    else if (rpgClass === "Cult Leader") mtgColor = "black";
    else if (rpgClass === "Bubble Burster") mtgColor = "red";
    else if (rpgClass === "Oracle") mtgColor = "green";

    // Flavor Text
    const flavorTextMap = {
        "Technomancer": "Logic is a prison waiting to be broken.",
        "Cult Leader": "Belief is the only currency that matters.",
        "Bubble Burster": "Reality has a way of asserting itself.",
        "Oracle": "I see what you refuse to acknowledge.",
        "Doomer": "The end is not near, it is here."
    };
    const flavorText = flavorTextMap[rpgClass] || "A watcher of the bubble.";

    // Last Entry Date (for sorting)
    const latestDate = Math.max(...c.predictions.map(p => {
        const d = p.uploadDate ? new Date(p.uploadDate) : new Date(0);
        return d.getTime();
    }));

    return { ...c, stats, successRate, rpgClass, rarity, mtgColor, flavorText, latestDate };
    // @ts-ignore
}).sort((a, b) => b.total - a.total); // Default sort
---

<Layout lang={lang} title={`${t.player_cards_title} - ${t.title}`}>
    <main>
        <h1 id="player-cards-title">{t.player_cards_title}</h1>

        <!-- Sorting Controls -->
        <div class="sort-controls">
            <label for="sort-select" class="sort-label">Sort by:</label>
            <select id="sort-select" class="sort-select">
                <option value="famous_desc">Most Famous</option>
                <option value="famous_asc">Least Famous</option>
                <option value="date_desc">Latest Entry</option>
                <option value="date_asc">Oldest Entry</option>
                <option value="name_asc">Name (A-Z)</option>
                <option value="name_desc">Name (Z-A)</option>
            </select>
        </div>

        <div class="player-container">
            <!-- Grid View -->
            <div id="player-grid-view" class="">
                <div class="player-grid" id="player-grid-container">
                    {players.map(player => (
                        <div class="player-card-mini"
                             data-player-name={player.name}
                             data-rarity={player.rarity}
                             data-mtg-color={player.mtgColor}
                             data-latest-date={player.latestDate}>

                             <!-- Mini MTG Card Structure -->
                             <div class={`mtg-card-container mini ${player.mtgColor.toLowerCase()} ${player.rarity.toLowerCase()}`}>
                                <div class="mtg-card-border">
                                    <div class="mtg-card-content">
                                        <!-- Header -->
                                        <div class="mtg-header">
                                            <span class="mtg-card-name">{player.name}</span>
                                            <span class="mtg-mana-cost">{player.total}</span>
                                        </div>

                                        <!-- Art -->
                                        <div class="mtg-art-frame">
                                            <div class="mtg-art-inner">
                                                <div class="rpg-avatar">{player.name.substring(0, 1).toUpperCase()}</div>
                                            </div>
                                        </div>

                                        <!-- Type Line -->
                                        <div class="mtg-type-line">
                                            <span class="type-text">{player.rpgClass}</span>
                                            <div class="mtg-set-symbol"></div>
                                        </div>

                                        <!-- Text Box -->
                                        <div class="mtg-text-box">
                                            <div class="mini-stats-grid">
                                                <span>STR: {player.stats.STR}</span>
                                                <span>INT: {player.stats.INT}</span>
                                                <span>CHA: {player.stats.CHA}</span>
                                                <span>LUCK: {player.stats.LUCK}</span>
                                            </div>
                                        </div>

                                        <!-- Footer -->
                                        <div class="mtg-footer">
                                            <div class="mtg-pt-box">
                                                {player.successes}/{player.total}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                             </div>

                        </div>
                    ))}
                </div>
            </div>

            <!-- Detail View -->
            <div id="player-detail-view" class="hidden">
                <div class="detail-nav-top">
                    <button id="back-to-grid" class="back-button">← Back</button>
                </div>

                <div class="detail-content-wrapper">
                    <button id="prev-card" class="nav-arrow side-arrow" aria-label="Previous">❮</button>

                    <div class="card-wrapper">
                        <div class="mtg-card-container detail-mode" id="mtg-card-container">
                            <!-- Dynamic classes for color/rarity will be added here via JS -->
                            <div class="mtg-card-border">
                                <div class="mtg-card-content">
                                    <!-- Header -->
                                    <div class="mtg-header">
                                        <div class="header-left">
                                            <span id="detail-name" class="mtg-card-name">Player Name</span>
                                            <button id="favorite-btn" class="favorite-star" title="Favorite this player">★</button>
                                        </div>
                                        <span id="detail-mana" class="mtg-mana-cost"></span>
                                    </div>

                                    <!-- Art -->
                                    <div class="mtg-art-frame">
                                        <div class="mtg-art-inner">
                                            <div class="rpg-avatar" id="detail-avatar"></div>
                                        </div>
                                    </div>

                                    <!-- Type Line -->
                                    <div class="mtg-type-line">
                                        <span id="detail-type-text">Legendary Creature — Class</span>
                                        <div id="detail-set-symbol" class="mtg-set-symbol"></div>
                                    </div>

                                    <!-- Text Box -->
                                    <div class="mtg-text-box">
                                        <ul id="detail-predictions-list" class="mtg-abilities-list">
                                            <!-- Populated by JS -->
                                        </ul>
                                        <div class="mtg-flavor-separator"></div>
                                        <div id="detail-flavor" class="mtg-flavor-text">
                                            "Flavor text goes here."
                                        </div>
                                    </div>

                                    <!-- Footer -->
                                    <div class="mtg-footer">
                                        <div class="mtg-pt-box">
                                            <span id="detail-pt">0 / 0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button id="next-card" class="nav-arrow side-arrow" aria-label="Next">❯</button>
                </div>
            </div>
        </div>
    </main>
</Layout>

<style>
    main {
        max-width: 80rem;
        margin: 4rem auto;
        padding: 0 1rem;
    }

    h1 {
        font-size: 3rem;
        font-weight: 900;
        text-align: center;
        margin-bottom: 2rem;
        color: white;
        background: linear-gradient(to right, #10B981, #059669);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* Grid View */
    .sort-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 2rem;
        gap: 1rem;
    }

    .sort-label {
        color: #D1D5DB;
        font-weight: 600;
    }

    .sort-select {
        background: rgba(31, 41, 55, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-family: 'Inter', sans-serif;
    }

    .player-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 2rem;
        margin-top: 1.5rem;
        perspective: 1000px;
    }

    /* Wrapper for grid items */
    .player-card-mini {
        width: 100%;
        aspect-ratio: 2.5/3.5;
        cursor: pointer;
        transition: transform 0.3s ease;
    }
    .player-card-mini:hover {
        transform: translateY(-10px) rotateX(5deg);
        z-index: 10;
    }

    /* Detail View Utils */
    .hidden { display: none !important; }

    .detail-nav-top {
        margin-bottom: 1rem;
    }

    .detail-content-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
    }

    .card-wrapper {
        flex: 1;
        max-width: 400px;
    }

    .back-button, .nav-arrow {
        background: rgba(31, 41, 55, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    .back-button:hover, .nav-arrow:hover {
        background: rgba(55, 65, 81, 0.8);
        border-color: #60A5FA;
    }

    .side-arrow {
        font-size: 1.5rem;
        padding: 0.5rem 1rem;
        height: fit-content;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .side-arrow:hover {
        background: rgba(0, 0, 0, 0.8);
    }

    /* Mobile responsiveness for arrows */
    @media (max-width: 600px) {
        .detail-content-wrapper {
            position: relative;
        }
        .side-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 20;
            padding: 0.5rem 0.8rem;
        }
        #prev-card { left: -1rem; }
        #next-card { right: -1rem; }
    }
</style>

<!-- GLOBAL STYLES FOR MTG CARDS (to support client-side rendering) -->
<style is:global>
    /* SHARED MTG STYLES (Used for both Mini and Detail) */
    .mtg-card-container {
        width: 100%;
        height: 100%;
        font-family: 'Times New Roman', serif;
        position: relative;
        border-radius: 4.5% / 3.5%; /* Card aspect ratio radius */
        padding: 3%;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
    }

    .mtg-card-container.mini {
        font-size: 10px; /* Base font size for mini cards */
    }

    /* Colors */
    .mtg-card-container.white { background: linear-gradient(135deg, #e0e0e0, #ffffff); }
    .mtg-card-container.blue { background: linear-gradient(135deg, #2b6cb0, #90cdf4); }
    .mtg-card-container.black { background: linear-gradient(135deg, #1a202c, #4a5568); }
    .mtg-card-container.red { background: linear-gradient(135deg, #9b2c2c, #fc8181); }
    .mtg-card-container.green { background: linear-gradient(135deg, #276749, #68d391); }

    .mtg-card-border {
        background: #171717;
        border-radius: 3.5% / 2.5%;
        padding: 1.5%;
        height: 100%;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
    }

    .mtg-card-content {
        background: #d4d4d4; /* Default artifact/colorless */
        border-radius: 2% / 1.5%;
        padding: 2.5%;
        display: flex;
        flex-direction: column;
        gap: 2%;
        height: 100%;
        position: relative;
        box-sizing: border-box;
    }
    .mtg-card-content::before {
        content: '';
        position: absolute;
        top:0; left:0; width:100%; height:100%;
        opacity: 0.05;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        pointer-events: none;
        border-radius: inherit;
    }

    /* Inner Face Colors */
    .mtg-card-container.white .mtg-card-content { background: #F3F4F6; }
    .mtg-card-container.blue .mtg-card-content { background: #BFDBFE; }
    .mtg-card-container.black .mtg-card-content { background: #D1D5DB; }
    .mtg-card-container.red .mtg-card-content { background: #FECACA; }
    .mtg-card-container.green .mtg-card-content { background: #A7F3D0; }

    /* Header */
    .mtg-header {
        border: 1px solid #4a5568;
        background: rgba(255,255,255,0.7);
        border-radius: 4px;
        padding: 1% 2%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        z-index: 1;
        flex-shrink: 0;
    }
    .header-left {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        overflow: hidden;
        flex: 1;
    }
    .mtg-card-name {
        font-weight: 700;
        font-size: 1.1em;
        color: #1a202c;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .favorite-star {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        color: #9CA3AF;
        padding: 0;
        line-height: 1;
        transition: color 0.2s, transform 0.2s;
    }
    .favorite-star:hover {
        transform: scale(1.1);
    }
    .favorite-star.active {
        color: #F59E0B; /* Gold */
        text-shadow: 0 0 2px rgba(0,0,0,0.5);
    }
    .mtg-mana-cost {
        font-weight: 700;
        color: #1a202c;
        font-size: 0.9em;
        background: #E5E7EB;
        border-radius: 50%;
        width: 1.5em;
        height: 1.5em;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #4B5563;
        box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        flex-shrink: 0;
    }

    /* Art */
    .mtg-art-frame {
        background: #000;
        padding: 1px;
        border: 1px solid #4a5568;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        flex: 3; /* Take up space */
        min-height: 0;
        display: flex;
        flex-direction: column;
    }
    .mtg-art-inner {
        background: #1F2937;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
    }
    .rpg-avatar {
        width: 3.5em;
        height: 3.5em;
        border-radius: 50%;
        background: rgba(255,255,255,0.05);
        border: 2px solid rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        font-weight: 900;
        color: rgba(255,255,255,0.8);
        text-shadow: 0 0 10px rgba(255,255,255,0.5);
    }
    .detail-mode .rpg-avatar {
         width: 100px; height: 100px; font-size: 4rem;
    }

    /* Type Line */
    .mtg-type-line {
        border: 1px solid #4a5568;
        background: rgba(255,255,255,0.7);
        padding: 1% 2%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8em;
        font-weight: 700;
        color: #1a202c;
        box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        z-index: 1;
        border-radius: 4px;
        flex-shrink: 0;
    }

    .mtg-set-symbol {
        font-size: 1.2em;
        line-height: 1;
    }
    .mtg-card-container.common .mtg-set-symbol::after { content: '●'; color: #1a202c; }
    .mtg-card-container.rare .mtg-set-symbol::after { content: '★'; color: #C0C0C0; text-shadow: 1px 1px 0 #000; }
    .mtg-card-container.epic .mtg-set-symbol::after { content: '◆'; color: #9F7AEA; text-shadow: 1px 1px 0 #000; }
    .mtg-card-container.legendary .mtg-set-symbol::after { content: '♛'; color: #F6AD55; text-shadow: 1px 1px 0 #000; }

    /* Text Box */
    .mtg-text-box {
        border: 1px solid #4a5568;
        background: rgba(255,255,255,0.8);
        padding: 2%;
        flex: 2; /* Take remaining space */
        font-size: 0.8em;
        color: #1a202c;
        display: flex;
        flex-direction: column;
        gap: 2%;
        z-index: 1;
        border-radius: 4px;
        min-height: 0;
        overflow: hidden;
    }

    .mini-stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.2rem;
        font-size: 0.85em;
        font-weight: 600;
    }

    .mtg-abilities-list {
        list-style: none;
        padding: 0;
        margin: 0;
        flex: 1;
        overflow-y: auto;
    }

    .mtg-abilities-list li {
        margin-bottom: 0.4rem;
        line-height: 1.2;
        display: flex;
        gap: 0.4rem;
        align-items: flex-start;
    }

    .mtg-ability-bullet {
        font-size: 0.8rem;
        margin-top: 1px;
    }
    .bullet-future { color: #3B82F6; text-shadow: 0 0 1px #3B82F6; }
    .bullet-active { color: #10B981; text-shadow: 0 0 1px #10B981; }
    .bullet-expired { color: #EF4444; text-shadow: 0 0 1px #EF4444; }

    .mtg-flavor-separator {
        height: 1px;
        background: #4a5568;
        opacity: 0.3;
        margin: 0.2rem 0;
        width: 80%;
        align-self: center;
    }

    .mtg-flavor-text {
        font-style: italic;
        font-size: 0.9em;
        opacity: 0.9;
        text-align: center;
    }

    /* Footer / P/T */
    .mtg-footer {
        display: flex;
        justify-content: flex-end;
        margin-top: -10%;
        margin-right: -2%;
        z-index: 10;
        position: relative;
    }
    .mtg-pt-box {
        background: #E5E7EB;
        border: 2px solid #4a5568;
        padding: 0.2em 0.6em;
        border-radius: 12px;
        font-weight: 800;
        font-size: 1em;
        color: #1a202c;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    }
    .mtg-card-container.black .mtg-pt-box { background: #D1D5DB; }
    .mtg-card-container.blue .mtg-pt-box { background: #BFDBFE; }

    /* DETAIL OVERRIDES */
    .mtg-card-container.detail-mode {
        width: 100%;
        font-size: 16px; /* Reset font size */
        border-radius: 18px;
        padding: 12px;
    }
    .detail-mode .mtg-card-border {
         border-radius: 12px;
         padding: 5px;
    }
    .detail-mode .mtg-card-content {
        padding: 0.6rem;
        gap: 0.35rem;
    }
    .detail-mode .mtg-header, .detail-mode .mtg-type-line {
        border-width: 2px;
        padding: 0.3rem 0.5rem;
    }
    .detail-mode .mtg-text-box {
        border-width: 2px;
        padding: 0.8rem;
        min-height: 160px;
    }
    .detail-mode .mtg-art-frame {
        border-width: 2px;
        height: 180px;
        flex: initial;
    }
    .detail-mode .mtg-footer {
        margin-top: -16px;
        margin-right: -4px;
    }
</style>

<script define:vars={{ translations, lang, players }}>
    // We need to inject the logic to handle the card interactions here
    // It is almost identical to the modal logic but scoped to this page

    function init() {
        let currentLang = lang;
        try {
            currentLang = localStorage.getItem('language') || document.cookie.split('; ').find(row => row.startsWith('language='))?.split('=')[1] || lang;
        } catch (e) {
            console.warn('Language detection failed:', e);
        }

        const t = translations[currentLang] || translations['en'];

        // Update title if needed
        const title = document.getElementById('player-cards-title');
        if (title) title.textContent = t.player_cards_title;

        // Interaction Logic
        const gridView = document.getElementById('player-grid-view');
        const detailView = document.getElementById('player-detail-view');
        const backBtn = document.getElementById('back-to-grid');
        const gridContainer = document.getElementById('player-grid-container');
        const sortSelect = document.getElementById('sort-select');
        const prevBtn = document.getElementById('prev-card');
        const nextBtn = document.getElementById('next-card');
        const favBtn = document.getElementById('favorite-btn');

        let currentSortedPlayers = [...players];
        let currentIndex = -1;

        // Favorite Logic
        function isFavorite(name) {
            try {
                return localStorage.getItem('favorite_player') === name;
            } catch (e) { return false; }
        }

        function setFavorite(name) {
            try {
                if (isFavorite(name)) {
                    localStorage.removeItem('favorite_player');
                    updateFavBtn(false);
                } else {
                    localStorage.setItem('favorite_player', name);
                    updateFavBtn(true);
                }
            } catch (e) {}
        }

        function updateFavBtn(isFav) {
            if (!favBtn) return;
            if (isFav) {
                favBtn.classList.add('active');
            } else {
                favBtn.classList.remove('active');
            }
        }

        if (favBtn) {
            favBtn.addEventListener('click', () => {
                if (currentIndex >= 0 && currentSortedPlayers[currentIndex]) {
                    setFavorite(currentSortedPlayers[currentIndex].name);
                }
            });
        }

        // Rarity Priority Map for Sorting
        const rarityVal = { "Legendary": 4, "Epic": 3, "Rare": 2, "Common": 1 };

        function updateGrid() {
            if (!gridContainer) return;
            gridContainer.innerHTML = '';

            // Re-render based on sorted list
            currentSortedPlayers.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-card-mini';
                div.dataset.playerName = player.name;
                div.dataset.rarity = player.rarity;
                div.dataset.mtgColor = player.mtgColor;
                div.dataset.latestDate = player.latestDate;

                // Mini MTG Card HTML Construction
                div.innerHTML = `
                    <div class="mtg-card-container mini ${player.mtgColor.toLowerCase()} ${player.rarity.toLowerCase()}">
                        <div class="mtg-card-border">
                            <div class="mtg-card-content">
                                <div class="mtg-header">
                                    <span class="mtg-card-name">${player.name}</span>
                                    <span class="mtg-mana-cost">${player.total}</span>
                                </div>
                                <div class="mtg-art-frame">
                                    <div class="mtg-art-inner">
                                        <div class="rpg-avatar">${player.name.substring(0, 1).toUpperCase()}</div>
                                    </div>
                                </div>
                                <div class="mtg-type-line">
                                    <span class="type-text">${player.rpgClass}</span>
                                    <div class="mtg-set-symbol"></div>
                                </div>
                                <div class="mtg-text-box">
                                    <div class="mini-stats-grid">
                                        <span>STR: ${player.stats.STR}</span>
                                        <span>INT: ${player.stats.INT}</span>
                                        <span>CHA: ${player.stats.CHA}</span>
                                        <span>LUCK: ${player.stats.LUCK}</span>
                                    </div>
                                </div>
                                <div class="mtg-footer">
                                    <div class="mtg-pt-box">
                                        ${player.successes}/${player.total}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                div.addEventListener('click', () => openDetail(player.name));
                gridContainer.appendChild(div);
            });
        }

        function sortPlayers(mode) {
            if (mode === 'famous_desc') {
                currentSortedPlayers.sort((a, b) => (rarityVal[b.rarity] || 1) - (rarityVal[a.rarity] || 1));
            } else if (mode === 'famous_asc') {
                currentSortedPlayers.sort((a, b) => (rarityVal[a.rarity] || 1) - (rarityVal[b.rarity] || 1));
            } else if (mode === 'date_desc') {
                currentSortedPlayers.sort((a, b) => b.latestDate - a.latestDate);
            } else if (mode === 'date_asc') {
                currentSortedPlayers.sort((a, b) => a.latestDate - b.latestDate);
            } else if (mode === 'name_asc') {
                currentSortedPlayers.sort((a, b) => a.name.localeCompare(b.name));
            } else if (mode === 'name_desc') {
                currentSortedPlayers.sort((a, b) => b.name.localeCompare(a.name));
            }
            updateGrid();
        }

        if (sortSelect) {
            sortSelect.addEventListener('change', (e) => sortPlayers(e.target.value));
            // Initial sort
            sortPlayers(sortSelect.value);
        }

        function openDetail(name) {
             const index = currentSortedPlayers.findIndex(p => p.name === name);
             if (index === -1) return;
             currentIndex = index;
             renderDetail(currentSortedPlayers[currentIndex]);

             gridView.classList.add('hidden');
             detailView.classList.remove('hidden');
        }

        function renderDetail(player) {
            // Populate Detail View (MTG Style)
            const dName = document.getElementById('detail-name');
            if (dName) dName.textContent = player.name;

            const dType = document.getElementById('detail-type-text');
            if (dType) dType.textContent = `${player.rarity} ${player.rpgClass}`;

            const dMana = document.getElementById('detail-mana');
            if (dMana) dMana.textContent = player.total;

            const dAvatar = document.getElementById('detail-avatar');
            if (dAvatar) dAvatar.textContent = player.name.substring(0, 1).toUpperCase();

            const dPt = document.getElementById('detail-pt');
            if (dPt) dPt.textContent = `${player.successes}/${player.total}`;

            const dFlavor = document.getElementById('detail-flavor');
            if (dFlavor) dFlavor.textContent = `"${player.flavorText}"`;

            // Update Lists
            const list = document.getElementById('detail-predictions-list');
            if (list) {
                list.innerHTML = '';
                player.predictions.forEach(p => {
                    const li = document.createElement('li');

                    // Localize claim if object
                    let claimText = '';
                    if (typeof p.claim === 'string') claimText = p.claim;
                    else if (typeof p.claim === 'object') claimText = p.claim[currentLang] || p.claim['en'];

                    let bulletColorClass = 'bullet-future';
                    if (p.status === 'ACTIVE') bulletColorClass = 'bullet-active';
                    if (p.status === 'EXPIRED') bulletColorClass = 'bullet-expired';

                    // Use a colored bullet point instead of text label
                    li.innerHTML = `<span class="mtg-ability-bullet ${bulletColorClass}">●</span> <span>${claimText}</span>`;
                    list.appendChild(li);
                });
            }

            // Apply Styles
            const container = document.getElementById('mtg-card-container');
            if (container) {
                container.className = 'mtg-card-container detail-mode'; // Reset
                container.classList.add(player.mtgColor.toLowerCase());
                container.classList.add(player.rarity.toLowerCase());
            }

             // Update Favorite Button State
             updateFavBtn(isFavorite(player.name));
        }

        if (backBtn && gridView && detailView) {
            backBtn.addEventListener('click', () => {
                detailView.classList.add('hidden');
                gridView.classList.remove('hidden');
            });
        }

        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    renderDetail(currentSortedPlayers[currentIndex]);
                } else {
                    // Loop to end
                    currentIndex = currentSortedPlayers.length - 1;
                    renderDetail(currentSortedPlayers[currentIndex]);
                }
            });
        }

        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                if (currentIndex < currentSortedPlayers.length - 1) {
                    currentIndex++;
                    renderDetail(currentSortedPlayers[currentIndex]);
                } else {
                    // Loop to start
                    currentIndex = 0;
                    renderDetail(currentSortedPlayers[currentIndex]);
                }
            });
        }
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
