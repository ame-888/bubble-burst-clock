---
import Layout from '../layouts/Layout.astro';
import { benchmarks } from '../data/benchmarks';
import { getSimulatedDate, TIME_OFFSET } from '../scripts/TimeUtils';
import en from '../locales/en.json';
import ptBR from '../locales/pt-BR.json';
import ja from '../locales/ja.json';
import es from '../locales/es.json';
import zh from '../locales/zh.json';

const translations = {
    'en': en,
    'pt-BR': ptBR,
    'ja': ja,
    'es': es,
    'zh': zh,
};

const lang = 'en';
const t = translations[lang];

// --- Simulated Time for Context ---
const SIMULATED_NOW = getSimulatedDate();

function isNew(dateStr) {
    if (!dateStr) return false;
    const release = new Date(dateStr);
    const now = new Date(SIMULATED_NOW);
    // Reset hours to compare just dates
    release.setHours(0,0,0,0);
    now.setHours(0,0,0,0);

    const diffTime = now.getTime() - release.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    // Show new for items released in the last 30 days
    return diffDays >= -1 && diffDays <= 30;
}

// --- Ranking Logic ---
function computeRanks(items, scoreKey) {
    // 1. Sort
    let sorted = [...items].sort((a, b) => b[scoreKey] - a[scoreKey]);

    // 2. Separate Zeroes
    const eligible = sorted.filter(i => i[scoreKey] > 0);
    const fails = sorted.filter(i => i[scoreKey] === 0).sort((a,b) => a.name.localeCompare(b.name));

    // 3. Assign ranks to eligible
    let currentRank = 1;
    let previousScore = null;
    let rankedItems = [];

    eligible.forEach((item) => {
        if (item.name === 'Human Baseline') {
            rankedItems.push({ ...item, rank: '-', isFail: false });
            return;
        }

        const score = item[scoreKey];

        if (previousScore !== null && score < previousScore) {
            currentRank++;
        }

        rankedItems.push({ ...item, rank: currentRank, isFail: false });
        previousScore = score;
    });

    // 4. Append Fails
    fails.forEach(item => {
        rankedItems.push({ ...item, rank: 'EPIC FAIL', isFail: true });
    });

    return rankedItems;
}

function getZone(score) {
    if (score >= 90) return 'saturated';
    if (score >= 50) return 'impressive';
    if (score >= 10) return 'competent';
    return 'noise';
}

function attachZone(items, scoreKey) {
    return items.map(item => {
        let score = item[scoreKey];
        if (item.isFail) score = 0;
        if (item.name === 'Human Baseline') score = 100;
        return { ...item, zone: getZone(score) };
    });
}

// Easy Mode Logic (Averages)
const rawEasy = benchmarks.models.map(m => {
    const scores = Object.values(m.scores);
    const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
    return { ...m, avg };
});
const easyZoned = attachZone(computeRanks(rawEasy, 'avg'), 'avg');

// Hard Mode Logic
const hardZoned = attachZone(computeRanks(benchmarks.hardMode, 'score'), 'score');

// Impossible Mode Logic
const impossibleZoned = attachZone(computeRanks(benchmarks.impossibleMode, 'score'), 'score');

const ZONES = ['saturated', 'impressive', 'competent', 'noise'];

function getRankDisplay(rank) {
    if (rank === '-') return '-';
    if (rank === 'EPIC FAIL') return 'EPIC FAIL';
    if (rank === 1) return 'ðŸ¥‡';
    if (rank === 2) return 'ðŸ¥ˆ';
    if (rank === 3) return 'ðŸ¥‰';
    return `#${rank}`;
}
---

<Layout lang={lang} title={`${t.leaderboard_button} - ${t.title}`}>
    <main>
        <h1 id="leaderboard-title">{t.leaderboard_button}</h1>

        <div class="leaderboard-grid">
            <!-- Benchmarks Section -->
            <section class="leaderboard-section full-width">
                <h2 id="benchmark-title">{t.benchmark_title}</h2>

                <div class="benchmark-scroll-container">
                    <div class="benchmark-container">
                        <!-- Header Row -->
                        <div class="header-row">
                            <div class="col-header col-easy"><h3>EASY MODE</h3></div>
                            <div class="col-header col-hard"><h3>HARD MODE</h3></div>
                            <div class="col-header col-impossible impossible-header"><h3>IMPOSSIBLE MODE</h3></div>
                        </div>

                        <!-- Zones -->
                        {ZONES.map(zone => (
                            <div class="zone-section">
                                <div class={`zone-header zone-${zone}`}>{t[`zone_${zone}`]}</div>
                                <div class="zone-content">
                                    <!-- Easy Column -->
                                    <div class="zone-column col-easy">
                                        {easyZoned.filter(m => m.zone === zone).map(m => (
                                            <div class={`benchmark-item ${m.isFail ? 'fail-item' : ''} ${m.name === 'Human Baseline' ? 'human-baseline' : ''}`}>
                                                <div class={`rank ${m.isFail ? 'fail-rank' : ''}`}>
                                                    {getRankDisplay(m.rank)}
                                                </div>
                                                <div class="model-info">
                                                    <div class="model-name" data-release-date={m.releaseDate}>
                                                        {m.name}
                                                        {isNew(m.releaseDate) && <span class="new-badge">NEW</span>}
                                                    </div>
                                                </div>
                                                <div class={`model-score ${m.isFail ? 'fail-score' : ''}`}>{m.avg.toFixed(1)}%</div>
                                            </div>
                                        ))}
                                    </div>

                                    <!-- Hard Column -->
                                    <div class="zone-column col-hard">
                                        {hardZoned.filter(m => m.zone === zone).map(m => (
                                            <div class={`benchmark-item ${m.isFail ? 'fail-item' : ''} ${m.name === 'Human Baseline' ? 'human-baseline' : ''}`}>
                                                <div class={`rank ${m.isFail ? 'fail-rank' : ''}`}>
                                                    {getRankDisplay(m.rank)}
                                                </div>
                                                <div class="model-info">
                                                    <div class="model-name" data-release-date={m.releaseDate}>
                                                        {m.name}
                                                        {isNew(m.releaseDate) && <span class="new-badge">NEW</span>}
                                                    </div>
                                                </div>
                                                <div class={`model-score ${m.isFail ? 'fail-score' : ''}`}>{m.score}%</div>
                                            </div>
                                        ))}
                                    </div>

                                    <!-- Impossible Column -->
                                    <div class="zone-column col-impossible">
                                        {impossibleZoned.filter(m => m.zone === zone).map(m => (
                                            <div class={`benchmark-item ${m.isFail ? 'fail-item' : ''} ${m.name === 'Human Baseline' ? 'human-baseline' : ''}`}>
                                                <div class={`rank ${m.isFail ? 'fail-rank' : ''} ${m.isFail ? '' : 'impossible-rank'}`}>
                                                    {getRankDisplay(m.rank)}
                                                </div>
                                                <div class="model-info">
                                                    <div class={`model-name ${m.isFail ? '' : 'impossible-text'}`} data-release-date={m.releaseDate}>
                                                        {m.name}
                                                        {isNew(m.releaseDate) && <span class="new-badge">NEW</span>}
                                                    </div>
                                                </div>
                                                <div class={`model-score ${m.isFail ? 'fail-score' : 'impossible-score'}`}>{m.score}%</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        ))}

                        <p class="disclaimer" id="benchmark-disclaimer">{t.benchmark_impossible_disclaimer}</p>
                        <p class="disclaimer contact-disclaimer" id="benchmark-contact">{t.benchmark_contact_disclaimer}</p>
                    </div>
                </div>
            </section>
        </div>
    </main>
</Layout>

<style>
    main {
        max-width: 90rem;
        margin: 4rem auto;
        padding: 0 1rem;
    }

    h1 {
        font-size: 3rem;
        font-weight: 900;
        text-align: center;
        margin-bottom: 3rem;
        color: white;
        background: linear-gradient(to right, #F59E0B, #EF4444);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    h2 {
        font-size: 2rem;
        font-weight: 700;
        color: white;
        margin-bottom: 1.5rem;
        text-align: center;
    }

    /* Scroll Container for Mobile */
    .benchmark-scroll-container {
        overflow-x: auto;
        padding-bottom: 1rem;
    }

    .benchmark-container {
        background: rgba(31, 41, 55, 0.5);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 0 30px rgba(0,0,0,0.2);
        border: 1px solid rgba(245, 158, 11, 0.3);
        min-width: 1000px;
    }

    /* Grid Layout */
    .header-row, .zone-content {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        /* No gap here, we use padding/borders */
    }

    .col-header {
        padding: 0 1.5rem;
        border-bottom: 2px solid rgba(245, 158, 11, 0.3);
        margin-bottom: 1rem;
    }
    .col-header h3 {
        font-size: 1.5rem;
        font-weight: 800;
        color: #F59E0B;
        margin-bottom: 0.5rem;
        text-align: center;
    }

    /* Column Dividers */
    .col-easy, .col-hard {
        border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    .zone-column {
        display: flex;
        flex-direction: column;
        padding: 0 1.5rem; /* Internal padding for content */
    }

    .zone-section {
        margin-bottom: 2rem;
    }

    .zone-header {
        grid-column: 1 / -1;
        font-size: 1rem;
        font-weight: 800;
        text-transform: uppercase;
        padding: 0.5rem 0;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        letter-spacing: 0.1em;
        text-align: left;
    }

    /* Item Styling - Compact & Clean */
    .benchmark-item {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        padding: 0.3rem 0.5rem;
        border-radius: 0.25rem;
        transition: background-color 0.2s;
    }

    .benchmark-item:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    .rank {
        font-size: 1.1rem;
        font-weight: 900;
        color: #F59E0B;
        min-width: 25px;
        text-align: right;
    }

    .human-baseline { opacity: 0.6; }
    .human-baseline .rank { color: #9CA3AF; }
    .fail-rank { color: #EF4444; font-size: 0.9rem; min-width: 60px; text-align: left; }

    .model-info { flex: 1; min-width: 0; }

    .model-name {
        font-size: 0.95rem;
        font-weight: 600;
        color: #e5e7eb; /* Slightly lighter gray-white */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .model-score {
        font-size: 1.1rem;
        font-weight: 800;
        color: #F59E0B;
        margin-left: auto;
    }

    .fail-score { color: #6B7280; font-size: 0.9rem; }

    /* Impossible Mode Styles */
    .impossible-header h3 {
        color: #ef4444;
        text-shadow:
            0 0 4px #7f1d1d,
            0 -5px 4px #ff9c00,
            2px -10px 6px #fd3e3e,
            -2px -15px 11px #f00;
        animation: burn 1.5s ease-in-out infinite alternate;
        border-color: #ef4444;
    }

    @keyframes burn {
        from { text-shadow: 0 0 4px #7f1d1d, 0 -5px 4px #ff9c00, 2px -10px 6px #fd3e3e, -2px -15px 11px #f00; }
        to { text-shadow: 0 0 4px #7f1d1d, 0 -2px 4px #ff9c00, 2px -5px 6px #fd3e3e, -2px -10px 11px #f00; }
    }

    .impossible-rank { color: #ef4444; }
    .impossible-score { color: #ef4444; text-shadow: 0 0 5px #7f1d1d; }
    .impossible-text { color: #fee2e2; }

    /* Override for Fail in Impossible Mode */
    .fail-item .impossible-score { color: #6B7280; text-shadow: none; }
    .fail-item .impossible-text { color: #e5e7eb; }

    /* New Badge */
    .new-badge {
        display: inline-block;
        margin-left: 0.3rem;
        font-size: 0.55rem;
        font-weight: 800;
        color: #713f12;
        background: linear-gradient(135deg, #fcd34d 0%, #f59e0b 100%);
        padding: 0 0.2rem;
        border-radius: 0.15rem;
        text-transform: uppercase;
        box-shadow: 0 0 3px rgba(245, 158, 11, 0.5);
        animation: shine 2s infinite;
        vertical-align: middle;
        border: 1px solid #fbbf24;
    }

    @keyframes shine {
        0% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(1.05); }
        100% { opacity: 1; transform: scale(1); }
    }

    .disclaimer {
        margin-top: 2rem;
        font-size: 0.9rem;
        color: #9CA3AF;
        font-style: italic;
        text-align: center;
        opacity: 0.8;
    }

    .contact-disclaimer { margin-top: 1rem; color: #60A5FA; }

    .zone-noise { color: #EF4444; border-color: rgba(239, 68, 68, 0.3); }
    .zone-competent { color: #F59E0B; border-color: rgba(245, 158, 11, 0.3); }
    .zone-impressive { color: #10B981; border-color: rgba(16, 185, 129, 0.3); }
    .zone-saturated { color: #3B82F6; border-color: rgba(59, 130, 246, 0.3); }
</style>

<script define:vars={{ translations, lang, TIME_OFFSET }}>
    function init() {
        // --- Translations ---
        let currentLang = lang;
        try {
            currentLang = localStorage.getItem('language') || document.cookie.split('; ').find(row => row.startsWith('language='))?.split('=')[1] || lang;
        } catch (e) {
            console.warn('Language detection failed:', e);
        }

        const t = translations[currentLang] || translations['en'];

        const mainTitle = document.getElementById('leaderboard-title');
        const benchTitle = document.getElementById('benchmark-title');
        const disclaimer = document.getElementById('benchmark-disclaimer');
        const contact = document.getElementById('benchmark-contact');

        if (mainTitle) mainTitle.textContent = t.leaderboard_button;
        if (benchTitle) benchTitle.textContent = t.benchmark_title;
        if (disclaimer) disclaimer.textContent = t.benchmark_impossible_disclaimer;
        if (contact) contact.textContent = t.benchmark_contact_disclaimer;

        // --- Dynamic "NEW" Badge Logic ---
        const timeOffset = TIME_OFFSET;
        const simNow = new Date(new Date().getTime() + timeOffset);

        document.querySelectorAll('.model-name[data-release-date]').forEach(el => {
            const dateStr = el.getAttribute('data-release-date');
            if (!dateStr) return;

            const release = new Date(dateStr);
            // Reset hours
            release.setHours(0,0,0,0);
            const today = new Date(simNow);
            today.setHours(0,0,0,0);

            const diffTime = today.getTime() - release.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // Should be new if within 30 days
            const isNew = diffDays >= -1 && diffDays <= 30;

            let badge = el.querySelector('.new-badge');
            if (isNew) {
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'new-badge';
                    badge.textContent = 'NEW';
                    el.appendChild(badge);
                }
            } else {
                if (badge) badge.remove();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
