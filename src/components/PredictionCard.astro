---
const { prediction, t, status, isSerialPopper, simulatedNow } = Astro.props;

// Time Ago Logic
let timeAgoLabel = '';
if (simulatedNow && prediction.uploadDate) {
    const now = new Date(simulatedNow);
    const upload = new Date(prediction.uploadDate);
    const diffTime = Math.abs(now - upload);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays < 7) {
        timeAgoLabel = `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
    } else if (diffDays < 30) {
        const weeks = Math.floor(diffDays / 7);
        timeAgoLabel = `${weeks} week${weeks !== 1 ? 's' : ''} ago`;
    } else if (diffDays < 365) {
        const months = Math.floor(diffDays / 30);
        timeAgoLabel = `${months} month${months !== 1 ? 's' : ''} ago`;
    } else {
        const years = Math.floor(diffDays / 365);
        timeAgoLabel = `${years} year${years !== 1 ? 's' : ''} ago`;
    }
}

// Map status to translation key and style class
let statusLabel = status;
let statusClass = 'status-badge-future';

// Fallback if no status prop (shouldn't happen with new logic)
if (!status) {
    statusLabel = 'FUTURE PREDICTION';
}

if (status === 'FUTURE PREDICTION') {
    statusLabel = t.future_prediction || 'FUTURE PREDICTION';
    statusClass = 'status-badge-future';
} else if (status === 'ACTIVE') {
    statusLabel = t.active_prediction || 'ACTIVE'; // Make sure this key exists in en.json
    statusClass = 'status-badge-active';
} else if (status === 'EXPIRED') {
    statusLabel = t.expired_prediction || 'EXPIRED'; // Make sure this key exists in en.json
    statusClass = 'status-badge-expired';
}

// Handle localized claim object
// Default to English ('en') if available, or the first available key, or a fallback string
let claimText = '';
if (typeof prediction.claim === 'string') {
    claimText = prediction.claim;
} else if (typeof prediction.claim === 'object' && prediction.claim !== null) {
    claimText = prediction.claim['en'] || Object.values(prediction.claim)[0] || '';
}

const news = prediction.news;

// Determine prediction type for visual distinction
const getPredictionType = (url) => {
    if (!url) return 'article';
    const lowerUrl = url.toLowerCase();

    if (lowerUrl.includes('youtube.com') || lowerUrl.includes('youtu.be') || lowerUrl.includes('vimeo.com')) {
        return 'video';
    }

    if (lowerUrl.includes('x.com') || lowerUrl.includes('twitter.com') || lowerUrl.includes('instagram.com') || lowerUrl.includes('threads.net') || lowerUrl.includes('reddit.com') || lowerUrl.includes('bsky.app')) {
        return 'social';
    }

    return 'article';
};

const predictionType = getPredictionType(prediction.videoUrl);
const cardTypeClass = `card-${predictionType}`;
const canBet = status !== 'EXPIRED';
---

<div class={`card-container ${cardTypeClass}`} data-upload-date={prediction.uploadDate} data-status={status} data-creator={prediction.creator}>
    <a href={prediction.videoUrl} target="_blank" rel="noopener noreferrer" class="card-link">
        <div class="thumbnail-wrapper">
            <img src={prediction.thumbnailUrl} alt={claimText} class="thumbnail" />
            <div class="play-overlay">
                {predictionType === 'video' && (
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="play-icon">
                        <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
                    </svg>
                )}
                {predictionType === 'social' && (
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="play-icon">
                        <path fill-rule="evenodd" d="M4.804 21.644A6.707 6.707 0 006 21.75a6.721 6.721 0 003.583-1.029c.774.182 1.584.279 2.417.279 5.322 0 9.75-3.97 9.75-9 0-5.03-4.428-9-9.75-9s-9.75 3.97-9.75 9c0 2.409 1.025 4.587 2.701 6.18.1.095.192.195.275.295.069.083.081.196.03.296l-1.05 2.053a.75.75 0 00.6 1.09z" clip-rule="evenodd" />
                    </svg>
                )}
                {predictionType === 'article' && (
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="play-icon">
                        <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" />
                        <path fill-rule="evenodd" d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 010-1.113zM17.25 12a5.25 5.25 0 11-10.5 0 5.25 5.25 0 0110.5 0z" clip-rule="evenodd" />
                    </svg>
                )}
            </div>
        </div>
        <div class="content">
            <div class="header">
                <div class="creator-wrapper">
                    <span class="creator">{t.creator_label}: {prediction.creator}</span>
                    {isSerialPopper && (
                        <span class="serial-popper-badge" data-tooltip={t.serial_popper_tooltip}>üçø</span>
                    )}
                </div>
                <span class={`status-badge ${statusClass}`}>{statusLabel}</span>
            </div>

            {timeAgoLabel && (
                <div class="time-ago-label">{timeAgoLabel}</div>
            )}

            <!-- Add data-prediction-id and a class for JS targeting -->
            <p class="claim prediction-claim-text" data-prediction-id={prediction.id}>"{claimText}"</p>

            {news && (
                <p class="news-item">
                    <span class="news-icon">üì∞</span> {news}
                </p>
            )}

            <div class="footer">
                {prediction.uploadDate && (
                    <span class="date-label">{t.upload_label}: {prediction.uploadDate}</span>
                )}
                {status === 'FUTURE PREDICTION' && (
                    <span class="date-label">{t.window_label}: {prediction.dateRange}</span>
                )}
            </div>
        </div>
    </a>

    {canBet && (
        <div class="betting-controls" data-prediction-id={prediction.id}>
            <button class="bet-btn bet-correct" data-type="correct" title={t.bet_correct || 'Claim is Correct'}>
                üëç
            </button>
            <button class="bet-btn bet-incorrect" data-type="incorrect" title={t.bet_incorrect || 'Claim is Incorrect'}>
                üëé
            </button>
        </div>
    )}
</div>

<style>
    .card-container {
        display: flex;
        flex-direction: column;
        background: rgba(31, 41, 55, 0.4);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        height: 100%;
        position: relative;
    }

    /* Video cards - Very rounded (Pill-like/Modern Media) */
    .card-video {
        border-radius: 1.5rem;
    }

    /* Social cards - Sharp (Square/Blocky) */
    .card-social {
        border-radius: 0;
    }

    /* Article cards - Standard/Rectangular */
    .card-article {
        border-radius: 0.5rem;
    }

    .card-container:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        border-color: rgba(96, 165, 250, 0.3);
    }

    .card-link {
        text-decoration: none;
        color: inherit;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }

    .thumbnail-wrapper {
        position: relative;
        aspect-ratio: 16 / 9;
        overflow: hidden;
    }

    .thumbnail {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .card-container:hover .thumbnail {
        transform: scale(1.05);
    }

    .play-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .card-container:hover .play-overlay {
        opacity: 1;
    }

    .play-icon {
        width: 3rem;
        height: 3rem;
        color: white;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }

    .content {
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        gap: 0.75rem;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .creator-wrapper {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .creator {
        color: #9CA3AF;
        font-weight: 500;
    }

    .serial-popper-badge {
        font-size: 1rem;
        cursor: help;
        position: relative;
    }

    .serial-popper-badge:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 120%;
        left: 50%;
        transform: translateX(-50%);
        background: #1F2937;
        color: white;
        padding: 0.5rem;
        border-radius: 0.5rem;
        font-size: 0.75rem;
        white-space: nowrap;
        border: 1px solid rgba(255,255,255,0.1);
        z-index: 10;
        pointer-events: none;
    }

    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.05em;
        border: 1px solid transparent;
    }

    .status-badge-future {
        background: rgba(59, 130, 246, 0.2);
        color: #60A5FA;
        border-color: rgba(59, 130, 246, 0.3);
    }

    .status-badge-active {
        background: rgba(16, 185, 129, 0.2);
        color: #34D399;
        border-color: rgba(16, 185, 129, 0.3);
    }

    .status-badge-expired {
        background: rgba(239, 68, 68, 0.2);
        color: #F87171;
        border-color: rgba(239, 68, 68, 0.3);
    }

    .claim {
        font-size: 1rem;
        line-height: 1.5;
        color: #F3F4F6;
        margin: 0;
        font-style: italic;
    }

    .news-item {
        font-size: 0.9rem;
        line-height: 1.4;
        color: #34D399; /* Bright green for contrast/positive news */
        background: rgba(16, 185, 129, 0.1);
        padding: 0.5rem;
        border-radius: 0.5rem;
        margin: 0.25rem 0 0.5rem 0;
        border-left: 3px solid #10B981;
    }

    .news-icon {
        margin-right: 0.25rem;
    }

    .footer {
        margin-top: auto;
        padding-top: 0.75rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .date-label {
        color: #D1D5DB;
        font-size: 0.875rem;
        font-weight: 500;
        display: block;
    }

    /* Betting Controls */
    .betting-controls {
        display: flex;
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    .bet-btn {
        flex: 1;
        background: transparent;
        border: none;
        padding: 0.75rem;
        cursor: pointer;
        font-size: 1.25rem;
        transition: background 0.2s;
        border-right: 1px solid rgba(255,255,255,0.1);
    }

    .bet-btn:last-child {
        border-right: none;
    }

    .bet-btn:hover {
        background: rgba(255,255,255,0.05);
    }

    .time-ago-label {
        font-size: 0.75rem;
        color: #FCD34D;
        font-weight: 600;
        background: rgba(245, 158, 11, 0.1);
        display: inline-block;
        padding: 0.1rem 0.4rem;
        border-radius: 0.25rem;
        border: 1px solid rgba(245, 158, 11, 0.2);
        margin-bottom: 0.25rem;
        align-self: flex-start;
    }

    /* Active States - applied via JS */
    :global(.bet-active-correct) {
        background: rgba(16, 185, 129, 0.2) !important;
        box-shadow: inset 0 0 10px rgba(16, 185, 129, 0.1);
    }

    :global(.bet-active-incorrect) {
        background: rgba(239, 68, 68, 0.2) !important;
        box-shadow: inset 0 0 10px rgba(239, 68, 68, 0.1);
    }
</style>
