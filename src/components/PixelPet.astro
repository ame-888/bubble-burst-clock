---
// Pixel Pet Component
// This component renders a pixel art pet based on CSS box-shadows.
// It handles its own client-side logic for interactions (petting, naming, releasing).
---

<div id="pixel-pet-container" class="pet-container hidden">
    <div class="pet-header">
        <h3 id="pet-name-display" class="pet-name">Companion</h3>
        <button id="pet-edit-btn" class="icon-btn edit-btn" title="Rename">✎</button>
    </div>

    <div class="pet-stage">
        <div id="pixel-pet" class="pixel-pet">
            <!-- The pixel art is injected via class based on type -->
            <div class="art-body"></div>
        </div>
        <div class="pet-hearts" id="pet-hearts"></div>
    </div>

    <div class="pet-controls">
        <div class="stats">
            <span title="Love"><span id="pet-love-count">0</span> ❤️</span>
            <span class="separator">|</span>
            <span title="Time together"><span id="pet-days-count">0</span> Days</span>
        </div>
        <button id="pet-release-btn" class="release-btn">Release</button>
    </div>

    <!-- Rename Modal -->
    <div id="rename-modal" class="mini-modal hidden">
        <input type="text" id="rename-input" placeholder="Name your pet..." maxlength="12">
        <div class="mini-modal-actions">
            <button id="cancel-rename" class="mini-btn cancel">✕</button>
            <button id="save-rename" class="mini-btn save">✓</button>
        </div>
    </div>
</div>

<!-- Release Confirmation Modal -->
<div id="release-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 class="modal-title">Release Companion?</h2>
        <p class="modal-msg">Are you sure you want to say goodbye? You might find another one later, but this specific friend will be gone forever.</p>
        <div class="modal-actions">
            <button id="cancel-release" class="modal-btn cancel">Stay</button>
            <button id="confirm-release" class="modal-btn confirm">Goodbye</button>
        </div>
    </div>
</div>

<style>
    .hidden { display: none !important; }

    .pet-container {
        margin-top: 4rem;
        background: rgba(17, 24, 39, 0.6);
        border: 2px dashed rgba(16, 185, 129, 0.3);
        border-radius: 1rem;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        position: relative;
    }

    .pet-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
    }

    .pet-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: #10B981;
        margin: 0;
    }

    .icon-btn {
        background: none;
        border: none;
        color: #6B7280;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0.25rem;
        transition: color 0.2s;
    }

    .icon-btn:hover { color: white; }

    .pet-stage {
        width: 100%;
        height: 150px;
        position: relative;
        overflow: hidden;
        border-bottom: 4px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 1rem;
        cursor: pointer;
    }

    .pixel-pet {
        position: absolute;
        bottom: 12px;
        left: 50%;
        width: 3px; /* Smaller pixel unit for more detail */
        height: 3px;
        transform-origin: bottom center;
        transition: transform 0.2s;
    }

    /*
       PIXEL ART DEFINITIONS (16x16 Grid optimized)
       Unit: 1em = 3px
    */
    .art-body {
        width: 1em;
        height: 1em;
        font-size: 3px;
        background: transparent;
    }

    /* DOG - Enhanced (Floppy ears, spotty) */
    .pet-type-dog .art-body {
        color: #D97706; /* Base Brown */
        box-shadow:
            /* Head */
            3em -11em #F59E0B, 4em -11em #F59E0B, 5em -11em #F59E0B, 6em -11em #F59E0B,
            2em -10em #F59E0B, 3em -10em #F59E0B, 4em -10em #F59E0B, 5em -10em #F59E0B, 6em -10em #F59E0B, 7em -10em #F59E0B,
            2em -9em #F59E0B, 3em -9em #FFF, 4em -9em #FFF, 5em -9em #F59E0B, 6em -9em #F59E0B, 7em -9em #F59E0B,
            /* Ears (Floppy) */
            1em -9em #92400E, 8em -9em #92400E,
            1em -8em #92400E, 8em -8em #92400E,
            /* Eyes/Nose */
            3em -9em #000, 6em -9em #000,
            4em -8em #000, 5em -8em #000,
            /* Body */
            3em -7em #F59E0B, 4em -7em #F59E0B, 5em -7em #F59E0B, 6em -7em #F59E0B,
            3em -6em #FFF, 4em -6em #FFF, 5em -6em #FFF, 6em -6em #FFF,
            3em -5em #F59E0B, 4em -5em #F59E0B, 5em -5em #F59E0B, 6em -5em #F59E0B,
            3em -4em #F59E0B, 4em -4em #F59E0B, 5em -4em #F59E0B, 6em -4em #F59E0B,
            /* Legs */
            3em -3em #F59E0B, 6em -3em #F59E0B,
            3em -2em #F59E0B, 6em -2em #F59E0B,
            /* Tail */
            7em -5em #F59E0B, 8em -6em #F59E0B, 9em -7em #FFF;
    }

    /* CAT - Enhanced (Tuxedo Cat) */
    .pet-type-cat .art-body {
        color: #1F2937; /* Black */
        box-shadow:
            /* Head */
            3em -11em, 6em -11em, /* Ear tips */
            2em -10em, 3em -10em, 4em -10em, 5em -10em, 6em -10em, 7em -10em,
            2em -9em, 3em -9em #10B981, 4em -9em, 5em -9em, 6em -9em #10B981, 7em -9em, /* Eyes Green */
            2em -8em, 3em -8em, 4em -8em #FFF, 5em -8em #FFF, 6em -8em, 7em -8em, /* White muzzle */
            /* Body */
            3em -7em, 4em -7em, 5em -7em, 6em -7em,
            3em -6em, 4em -6em #FFF, 5em -6em #FFF, 6em -6em, /* White Chest */
            3em -5em, 4em -5em, 5em -5em, 6em -5em,
            3em -4em, 4em -4em, 5em -4em, 6em -4em,
            /* Legs */
            3em -3em, 6em -3em,
            3em -2em #FFF, 6em -2em #FFF, /* White paws */
            /* Tail */
            7em -4em, 8em -3em, 8em -2em, 9em -1em;
    }

    /* MONKEY - Enhanced */
    .pet-type-monkey .art-body {
        color: #92400E;
        box-shadow:
            /* Head */
            4em -12em, 5em -12em,
            3em -11em, 4em -11em #FEF3C7, 5em -11em #FEF3C7, 6em -11em,
            2em -10em, 3em -10em #FEF3C7, 4em -10em #FEF3C7, 5em -10em #FEF3C7, 6em -10em #FEF3C7, 7em -10em,
            3em -9em #FEF3C7, 4em -9em #FEF3C7, 5em -9em #FEF3C7, 6em -9em #FEF3C7,
            /* Body */
            4em -8em, 5em -8em,
            3em -7em, 4em -7em, 5em -7em, 6em -7em,
            3em -6em, 4em -6em, 5em -6em, 6em -6em,
            3em -5em, 4em -5em, 5em -5em, 6em -5em,
            /* Limbs */
            2em -6em, 7em -6em,
            2em -5em, 7em -5em,
            3em -4em, 6em -4em,
            3em -3em, 6em -3em,
            /* Tail */
            7em -4em, 8em -5em, 9em -5em, 10em -4em;
    }

    /* RHINO - Enhanced */
    .pet-type-rhino .art-body {
        color: #6B7280;
        box-shadow:
            /* Head */
            2em -10em #E5E7EB, /* Horn Tip */
            2em -9em #E5E7EB, 3em -9em, 4em -9em,
            2em -8em, 3em -8em, 4em -8em, 5em -8em,
            /* Body */
            4em -7em, 5em -7em, 6em -7em, 7em -7em, 8em -7em,
            4em -6em, 5em -6em, 6em -6em, 7em -6em, 8em -6em, 9em -6em,
            4em -5em, 5em -5em, 6em -5em, 7em -5em, 8em -5em, 9em -5em,
            /* Legs */
            4em -4em, 5em -4em, 8em -4em, 9em -4em,
            4em -3em, 5em -3em, 8em -3em, 9em -3em,
            4em -2em, 5em -2em, 8em -2em, 9em -2em;
    }

    /* DRAGON - Enhanced */
    .pet-type-dragon .art-body {
        color: #047857;
        box-shadow:
            /* Horns */
            2em -13em #065F46, 4em -13em #065F46,
            /* Head */
            2em -12em, 3em -12em, 4em -12em,
            1em -11em, 2em -11em, 3em -11em, 4em -11em,
            /* Neck */
            3em -10em, 4em -10em,
            /* Body */
            3em -9em, 4em -9em, 5em -9em,
            3em -8em, 4em -8em, 5em -8em, 6em -8em,
            3em -7em, 4em -7em, 5em -7em, 6em -7em,
            /* Wings */
            5em -10em #EF4444, 6em -11em #EF4444, 7em -12em #EF4444,
            5em -9em #EF4444, 6em -8em #EF4444,
            /* Legs */
            3em -6em, 6em -6em,
            3em -5em, 6em -5em,
            /* Tail */
            7em -7em, 8em -6em, 9em -5em, 10em -4em;
    }

    /* FISH - Enhanced */
    .pet-type-fish .art-body {
        color: #3B82F6;
        box-shadow:
            /* Body */
            4em -8em, 5em -8em, 6em -8em,
            3em -7em, 4em -7em, 5em -7em, 6em -7em, 7em -7em,
            2em -6em, 3em -6em, 4em -6em, 5em -6em, 6em -6em, 7em -6em, 8em -6em #F59E0B, /* Tail start */
            3em -5em, 4em -5em, 5em -5em, 6em -5em, 7em -5em, 9em -7em #F59E0B, 9em -5em #F59E0B, /* Tail Tips */
            4em -4em, 5em -4em, 6em -4em,
            /* Fins */
            5em -9em #F59E0B, /* Top Fin */
            5em -3em #F59E0B, /* Bottom Fin */
            /* Bubble */
            9em -9em #A5F3FC, 10em -11em #A5F3FC;
    }

    /* Animation Classes */
    .walking .art-body {
        animation: bounce 0.4s infinite alternate;
    }

    @keyframes bounce {
        from { transform: translateY(0); }
        to { transform: translateY(-3px); }
    }

    .pet-hearts {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }

    .heart-particle {
        position: absolute;
        font-size: 1.5rem;
        animation: floatUp 1s ease-out forwards;
    }

    @keyframes floatUp {
        0% { transform: translateY(0) scale(1); opacity: 1; }
        100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
    }

    .pet-controls {
        display: flex;
        justify-content: space-between;
        width: 100%;
        align-items: center;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 1rem;
    }

    .stats {
        font-family: monospace;
        font-size: 1.1rem;
        color: #D1D5DB;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .separator {
        color: #4B5563;
    }

    .release-btn {
        background: transparent;
        color: #EF4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.2s;
    }

    .release-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: #EF4444;
    }

    /* Rename Modal */
    .mini-modal {
        position: absolute;
        top: 1rem;
        left: 50%;
        transform: translateX(-50%);
        background: #1F2937;
        border: 1px solid #10B981;
        padding: 0.5rem;
        border-radius: 0.5rem;
        display: flex;
        gap: 0.5rem;
        z-index: 10;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .mini-modal input {
        background: rgba(0,0,0,0.3);
        border: 1px solid #374151;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        outline: none;
    }

    .mini-btn {
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .mini-btn.save { background: #10B981; color: white; }
    .mini-btn.cancel { background: #374151; color: #9CA3AF; }

</style>

<script>
    class PixelPet {
        constructor() {
            this.container = document.getElementById('pixel-pet-container');
            this.el = document.getElementById('pixel-pet');
            this.nameEl = document.getElementById('pet-name-display');
            this.loveEl = document.getElementById('pet-love-count');
            this.daysEl = document.getElementById('pet-days-count');
            this.heartsContainer = document.getElementById('pet-hearts');
            this.data = null;

            // Movement State
            this.x = 50; // Percent
            this.targetX = 50;
            this.facingRight = true;
            this.isMoving = false;

            this.init();
        }

        init() {
            this.load();
            if (!this.data) return;

            this.render();
            this.attachListeners();
            this.startLoop();
        }

        load() {
            try {
                const raw = localStorage.getItem('pixel_pet');
                if (raw) {
                    this.data = JSON.parse(raw);
                    this.container.classList.remove('hidden');
                } else {
                    this.container.classList.add('hidden');
                }
            } catch (e) {
                console.error("Failed to load pet", e);
            }
        }

        save() {
            localStorage.setItem('pixel_pet', JSON.stringify(this.data));
        }

        render() {
            // Set Name
            this.nameEl.textContent = this.data.name || this.capitalize(this.data.type);
            this.loveEl.textContent = this.data.petted || 0;

            // Calculate Days
            const msPerDay = 1000 * 60 * 60 * 24;
            // Handle legacy data where obtainedAt might be missing
            const start = this.data.obtainedAt || Date.now();
            const days = Math.floor((Date.now() - start) / msPerDay);
            if (this.daysEl) this.daysEl.textContent = days.toString();

            // Set Type Class
            this.el.className = `pixel-pet pet-type-${this.data.type}`;
        }

        capitalize(s) {
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        attachListeners() {
            // Petting
            document.querySelector('.pet-stage').addEventListener('click', (e) => this.pet(e));

            // Rename
            const renameBtn = document.getElementById('pet-edit-btn');
            const renameModal = document.getElementById('rename-modal');
            const renameInput = document.getElementById('rename-input');
            const saveRename = document.getElementById('save-rename');
            const cancelRename = document.getElementById('cancel-rename');

            renameBtn.addEventListener('click', () => {
                renameModal.classList.remove('hidden');
                renameInput.value = this.data.name || '';
                renameInput.focus();
            });

            cancelRename.addEventListener('click', () => renameModal.classList.add('hidden'));

            saveRename.addEventListener('click', () => {
                const newName = renameInput.value.trim();
                if (newName) {
                    this.data.name = newName;
                    this.save();
                    this.nameEl.textContent = newName;
                    renameModal.classList.add('hidden');

                    // Unlock Achievement
                    if (window.AchievementManager) window.AchievementManager.unlock('pet_namer');
                }
            });

            // Release
            const releaseBtn = document.getElementById('pet-release-btn');
            const releaseModal = document.getElementById('release-modal');
            const cancelRelease = document.getElementById('cancel-release');
            const confirmRelease = document.getElementById('confirm-release');

            releaseBtn.addEventListener('click', () => releaseModal.classList.remove('hidden'));
            cancelRelease.addEventListener('click', () => releaseModal.classList.add('hidden'));

            confirmRelease.addEventListener('click', () => {
                localStorage.removeItem('pixel_pet');
                location.reload(); // Refresh to hide
            });
        }

        pet(e) {
            this.data.petted = (this.data.petted || 0) + 1;
            this.save();
            this.loveEl.textContent = this.data.petted;

            // Visuals
            this.spawnHeart(e.offsetX, e.offsetY);

            // Achievement
            if (window.AchievementManager && this.data.petted >= 10) {
                window.AchievementManager.unlock('pet_loved');
            }
        }

        spawnHeart(x, y) {
            const heart = document.createElement('div');
            heart.className = 'heart-particle';
            heart.textContent = '❤️';
            heart.style.left = `${x}px`;
            heart.style.top = `${y}px`;
            this.heartsContainer.appendChild(heart);
            setTimeout(() => heart.remove(), 1000);
        }

        // Logic Loop (Walking)
        startLoop() {
            setInterval(() => {
                this.update();
            }, 50);

            // Decide new target occasionally
            setInterval(() => {
                if (Math.random() < 0.3) {
                    this.targetX = 10 + Math.random() * 80; // Keep within 10-90%
                }
            }, 2000);
        }

        update() {
            const dx = this.targetX - this.x;

            if (Math.abs(dx) > 1) {
                this.isMoving = true;
                const speed = 0.5; // percent per tick
                const dir = Math.sign(dx);
                this.x += dir * speed;

                // Facing
                if (dir > 0 && !this.facingRight) this.facingRight = true;
                if (dir < 0 && this.facingRight) this.facingRight = false;

                // Apply Transform
                const scaleX = this.facingRight ? 1 : -1;
                // We multiply scaleX by existing scaling logic if any, but since we use font-size for pixels, regular scale works.
                // However, the base scale is 1. We just flip.
                this.el.style.left = `${this.x}%`;
                this.el.style.transform = `translateX(-50%) scaleX(${scaleX})`;

                // Add walking bounce class
                this.el.classList.add('walking');
            } else {
                this.isMoving = false;
                this.el.classList.remove('walking');
            }
        }
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        new PixelPet();
    });
</script>
